name: Release Docker Image

on:
  push:
    branches:
      - 'releases/**'
jobs:
  build:
    runs-on: ubuntu-latest
    env:
      IMAGE_NAME: marcoscostadev/kamiyomu

    outputs:
      version: ${{ steps.set_outputs.outputs.version }}
      version_suffix: ${{ steps.set_outputs.outputs.version_suffix }}
      is_prerelease: ${{ steps.set_outputs.outputs.is_prerelease }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up .NET
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: '8.0.x'

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Extract version and suffix from branch
        id: extract_version
        run: |
          BRANCH_NAME="${GITHUB_REF#refs/heads/}"
          RAW_VERSION="${BRANCH_NAME#releases/}"

          if [[ "$RAW_VERSION" == *"-"* ]]; then
            VERSION_BASE="${RAW_VERSION%%-*}"
            VERSION_SUFFIX="${RAW_VERSION#*-}"
            echo "VERSION_SUFFIX=-$VERSION_SUFFIX" >> $GITHUB_ENV
            echo "is_prerelease=true" >> $GITHUB_ENV
          else
            VERSION_BASE="$RAW_VERSION"
            VERSION_SUFFIX=""
            echo "VERSION_SUFFIX=" >> $GITHUB_ENV
            echo "is_prerelease=false" >> $GITHUB_ENV
          fi

          if [[ ! "$VERSION_BASE" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "âŒ Invalid VERSION_BASE format: '$VERSION_BASE'. Must be major.minor.patch"
            exit 1
          fi

          echo "VERSION=$VERSION_BASE" >> $GITHUB_ENV

      - name: Set outputs
        id: set_outputs
        run: |
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "version_suffix=${VERSION_SUFFIX}" >> $GITHUB_OUTPUT
          echo "is_prerelease=${is_prerelease}" >> $GITHUB_OUTPUT

      - name: Build multi-platform Docker image
        uses: docker/build-push-action@v5
        with:
          context: src
          file: src/KamiYomu.Web/Dockerfile
          platforms: linux/amd64,linux/arm64
          push: false
          tags: |
            ${{ env.IMAGE_NAME }}:${{ env.VERSION }}
          build-args: |
            VERSION=${{ env.VERSION }}
            VERSION_SUFFIX=${{ env.VERSION_SUFFIX }}
            BUILD_CONFIGURATION=Release

      - name: Save image as artifact
        run: |
          if [[ "$IS_PRERELEASE" == "true" ]]; then
            docker save $IMAGE_NAME:$VERSION$VERSION_SUFFIX -o image.tar
          else
            docker save $IMAGE_NAME:$VERSION -o image.tar
          fi

      - name: Upload image artifact
        uses: actions/upload-artifact@v4
        with:
          name: docker-image
          path: image.tar

  release:
    needs: build
    runs-on: ubuntu-latest
    env:
      IMAGE_NAME: marcoscostadev/kamiyomu
      VERSION: ${{ needs.build.outputs.version }}
      VERSION_SUFFIX: ${{ needs.build.outputs.version_suffix }}
      IS_PRERELEASE: ${{ needs.build.outputs.is_prerelease }}

    steps:
      - name: Download image artifact
        uses: actions/download-artifact@v4
        with:
          name: docker-image

      - name: Load Docker image
        run: docker load -i image.tar

      - name: Tag as latest (if not prerelease)
        if: env.IS_PRERELEASE == 'false'
        run: docker tag $IMAGE_NAME:$VERSION $IMAGE_NAME:latest

      - name: Log in to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.GH_KAMIYOMU_DOCKERHUB_USERNAME }}
          password: ${{ secrets.GH_KAMIYOMU_DOCKERHUB_TOKEN }}

      - name: Retag image if prerelease
        if: env.IS_PRERELEASE == 'true'
        run: |
          docker tag $IMAGE_NAME:$VERSION $IMAGE_NAME:$VERSION$VERSION_SUFFIX

      - name: Push version tag
        run: |
          TAG=$VERSION
          if [[ "$IS_PRERELEASE" == "true" ]]; then
            TAG="$VERSION$VERSION_SUFFIX"
          fi
          docker push $IMAGE_NAME:$TAG

      - name: Push latest tag (if not prerelease)
        if: env.IS_PRERELEASE == 'false'
        run: docker push $IMAGE_NAME:latest