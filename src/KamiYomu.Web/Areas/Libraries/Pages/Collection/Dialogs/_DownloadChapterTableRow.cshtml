@using KamiYomu.Web.Entities
@using KamiYomu.Web.Extensions
@using System.Text
@model ChapterDownloadRecord
@{
    var rowId = $"row-{Model.Id}";
    var badgeClass = Model.DownloadStatus switch
    {
        Entities.Definitions.DownloadStatus.Completed => "bg-success",
        Entities.Definitions.DownloadStatus.Cancelled => "bg-danger",
        Entities.Definitions.DownloadStatus.Scheduled => "bg-primary",
        Entities.Definitions.DownloadStatus.InProgress => "bg-info",
        _ => "bg-secondary"
    };
    var lastUpdateBuilder = new StringBuilder();
    lastUpdateBuilder.AppendLine($"{I18n.LastUpdate}: {Model.StatusUpdateAt}.");
    if (!string.IsNullOrWhiteSpace(Model.StatusReason))
    {
        lastUpdateBuilder.AppendLine(Model.StatusReason);
    }
}
<tr id="@rowId">
    <td>@Model.Chapter.GetCbzFileName()</td>
    <td>@Model.Chapter.GetCbzFileSize()</td>
    <td>
        <span class="badge @badgeClass"
              data-bs-toggle="popover"
              data-bs-trigger="hover focus"
              data-bs-placement="top"
              data-bs-content="@lastUpdateBuilder.ToString()">
            @(I18n.ResourceManager.GetString(Model.DownloadStatus.ToString())
                        ?? Model.DownloadStatus.ToString())
        </span>
    </td>
    <td>@Model.CreateAt.ToString("g")</td>
    <td class="text-end">
        <div class="btn-group">
            <button type="button" class="btn btn-sm btn-outline-secondary dropdown-toggle"
                    data-bs-toggle="dropdown" aria-expanded="false">
                <i class="bi bi-gear"></i> @I18n.Actions
            </button>
            <ul class="dropdown-menu dropdown-menu-end">
                <!-- Reschedule -->
                <li>
                    <form method="post"
                          hx-post='@Url.Page("DownloadChapterTable",
                                                                         values: new { handler = "Reschedule", libraryId = Model.MangaDownload.Library.Id, recordId = Model.Id })'
                          hx-target="#@rowId"
                          hx-swap="outerHTML">
                        @Html.AntiForgeryToken()
                        <button type="submit"
                                class="dropdown-item d-flex align-items-center gap-2"
                                @(Model.IsCompleted() || Model.IsCancelled() ? "" : "disabled")>
                            <i class="bi bi-arrow-repeat"></i> @I18n.Reschedule
                        </button>
                    </form>
                </li>

                <!-- Download -->
                <li>
                    <a class="dropdown-item d-flex align-items-center gap-2 @(Model.IsCompleted() ? "" : "disabled")"
                       href="@(Model.IsCompleted()
                                                       ? Url.Page("DownloadChapterTable",
                                                                  values: new { handler = "Download", libraryId = Model.MangaDownload.Library.Id, recordId = Model.Id })
                                                       : "#")"
                       target="_blank"
                       aria-disabled="@(Model.IsCompleted() ? "false" : "true")">
                        <i class="bi bi-download"></i> @I18n.Download
                    </a>
                </li>

                <!-- Cancel -->
                <li>
                    <form method="post"
                          hx-post='@Url.Page("DownloadChapterTable", new { handler = "Cancel", libraryId = Model.MangaDownload.Library.Id, recordId = Model.Id })'
                          hx-target="#@rowId"
                          hx-swap="outerHTML">
                        @Html.AntiForgeryToken()
                        <button type="submit"
                                class="dropdown-item d-flex align-items-center gap-2"
                                @(Model.IsInProgress() ? "" : "disabled")>
                            <i class="bi bi-x-circle"></i> @I18n.Cancel
                        </button>
                    </form>
                </li>
            </ul>
        </div>
    </td>
</tr>