@page
@using KamiYomu.Web.Extensions
@model KamiYomu.Web.Areas.Libraries.Pages.Collection.Dialogs.DownloadChapterTableModel
@{
    Layout = null;
}

<div id="downloads-table">
    <table class="table table-striped table-hover">
        <thead>
            <tr>
                <th>
                    <a href="#"
                       hx-get="@Url.Page("DownloadChapterTable", new { libraryId = Model.LibraryId, sort = "Chapter", asc = !Model.SortAsc, page = Model.CurrentPage })"
                       hx-target="#downloads-table" hx-swap="outerHTML" class="text-decoration-none">
                        @I18n.Chapter
                        @if (Model.SortColumn == "Chapter")
                        {
                            <i class="bi @(Model.SortAsc ? "bi-caret-up-fill" : "bi-caret-down-fill") ms-1"></i>
                        }
                    </a>
                </th>

                <th>
                    <a href="#"
                       hx-get="@Url.Page("DownloadChapterTable", new { libraryId = Model.LibraryId, sort = "Status", asc = !Model.SortAsc, page = Model.CurrentPage })"
                       hx-target="#downloads-table" hx-swap="outerHTML" class="text-decoration-none">
                        @I18n.Status
                        @if (Model.SortColumn == "Status")
                        {
                            <i class="bi @(Model.SortAsc ? "bi-caret-up-fill" : "bi-caret-down-fill") ms-1"></i>
                        }
                    </a>
                </th>

                <th>
                    <a href="#"
                       hx-get="@Url.Page("DownloadChapterTable", new { libraryId = Model.LibraryId, sort = "CreateAt", asc = !Model.SortAsc, page = Model.CurrentPage })"
                       hx-target="#downloads-table" hx-swap="outerHTML" class="text-decoration-none">
                        @I18n.LastUpdate
                        @if (Model.SortColumn == "CreateAt")
                        {
                            <i class="bi @(Model.SortAsc ? "bi-caret-up-fill" : "bi-caret-down-fill") ms-1"></i>
                        }
                    </a>
                </th>
            </tr>
        </thead>
        <tbody>
            @foreach (var record in Model.Records)
            {
                <tr>
                    <td>@record.Chapter.GetCbzFileName()</td>
                    <td>
                        <span class="badge
                    @(record.IsCompleted() ? "bg-success" :
                                                record.IsCancelled() ? "bg-danger" :
                                                record.IsInProgress() ? "bg-info" : "bg-secondary")">
                        @record.DownloadStatus
                    </span>
                </td>
                <td>@record.CreateAt.ToString("g")</td>
                <td class="text-end">
                    <div class="btn-group">
                        <button type="button" class="btn btn-sm btn-outline-secondary dropdown-toggle"
                                data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="bi bi-gear"></i> @I18n.Actions
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <!-- Reschedule -->
                            <li>
                                <button class="dropdown-item d-flex align-items-center gap-2"
                                        hx-post="/Libraries/Collection/Reschedule?recordId=@record.Id"
                                        hx-target="#downloads-table"
                                        hx-swap="outerHTML"
                                        @(record.IsCompleted() || record.IsCancelled() ? "" : "disabled")>
                                    <i class="bi bi-arrow-repeat"></i> @I18n.Reschedule
                                </button>
                            </li>

                                <!-- Download -->
                                <li>
                                    <a class="dropdown-item d-flex align-items-center gap-2"
                                       href="@Url.Page(
                                           "DownloadChapterTable",
                                           values: new { 
                                               handler = "Download",
                                               libraryId = record.MangaDownload.Library.Id, 
                                               recordId = record.Id 
                                           })"
                                       target="_blank"
                                       @(record.IsCompleted() ? "" : "disabled")>
                                        <i class="bi bi-download"></i> @I18n.Download
                                    </a>
                                </li>

                                <!-- Cancel -->
                                <li>
                                    <button class="dropdown-item d-flex align-items-center gap-2"
                                            hx-post="/Libraries/Collection/Cancel?recordId=@record.Id"
                                            hx-target="#downloads-table"
                                            hx-swap="outerHTML"
                                            @(record.IsInProgress() ? "" : "disabled")>
                                        <i class="bi bi-x-circle"></i> @I18n.Cancel
                                    </button>
                                </li>
                            </ul>
                        </div>
                    </td>
                </tr>
                        }
        </tbody>
    </table>

    <!-- Pagination -->
    <nav>
        <ul class="pagination justify-content-center">
            @for (int i = 1; i <= Model.TotalPages; i++)
            {
                <li class="page-item @(i == Model.CurrentPage ? "active" : "")">
                    <a class="page-link"
                       hx-get="@Url.Page("DownloadChapterTable", new { libraryId = Model.LibraryId, sort = Model.SortColumn, asc = Model.SortAsc, page = i })"
                       hx-target="#downloads-table" hx-swap="outerHTML">@i</a>
                </li>
            }
        </ul>
    </nav>
</div>